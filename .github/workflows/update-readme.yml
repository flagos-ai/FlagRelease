
name: Update README from HuggingFace

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # 每 6 小时更新一次

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get install -y jq
      
      - name: Fetch HuggingFace Models
        id: fetch
        run: |
          ORG="FlagRelease"
          API="https://huggingface.co/api/models?author=$ORG&limit=200"

          REMOVE_SUFFIXES=("-FlagOS" "-Nvidia" "-nvidia" "-Metax" "-metax" "-Iluvatar" "-iluvatar" "-Cambricon" "-cambricon" "-Kunlunxin" "-kunlunxin" "-Mthreads" "-mthreads" "-ascend" "-Ascend" "-Arm" "-hygon" "-Hygon")

          echo "Fetching models for org: $ORG"
          RESP=$(curl -s "$API")

          echo "$RESP" | jq 'if type=="array" then true else false end' || exit 1

          echo "$RESP" | jq -r '.[] | [.id, .cardData.description] | @tsv' > raw.tsv

          declare -A MODEL_MAP
          declare -A DESC_MAP

          normalize_name() {
            local full="$1"
            local clean="${full##*/}"   # 去掉 / 前缀

            local changed=1
            while [[ $changed -eq 1 ]]; do
              changed=0
              clean_lower="${clean,,}"
              for suf in "${REMOVE_SUFFIXES[@]}"; do
                suf_lower="${suf,,}"
                if [[ "$clean_lower" == *"$suf_lower"* ]]; then
                  clean=$(echo "$clean" | sed -E "s/${suf}//Ig")
                  changed=1
                  break
                fi
              done
            done

            clean=$(echo "$clean" | sed -E 's/-+/-/g')
            clean=$(echo "$clean" | sed -E 's/^-//; s/-$//')
            echo "$clean"
          }

          while IFS=$'\t' read -r ID DESC; do
            ORIG_ID="${ID##*/}"
            CLEAN=$(normalize_name "$ID")

            # 生成两个超链接
            LINK_HF="[Huggingface: ${ORIG_ID}](https://huggingface.co/FlagRelease/${ORIG_ID})"
            LINK_MS="[Modalscope: ${ORIG_ID}](https://modelscope.cn/models/FlagRelease/${ORIG_ID})"
            LINKS="${LINK_HF}<br>${LINK_MS}"

            if [[ -z "${MODEL_MAP[$CLEAN]}" ]]; then
              MODEL_MAP[$CLEAN]="$LINKS"
              DESC_MAP[$CLEAN]="${DESC:-无描述}"
            else
              MODEL_MAP[$CLEAN]="${MODEL_MAP[$CLEAN]}<br>$LINKS"
            fi
          done < raw.tsv

          # 生成 Markdown 表格
          echo '| Model Name | 原始模型 | ' > models.md
          echo '|------------|----------|' >> models.md

          for key in "${!MODEL_MAP[@]}"; do
            echo "| ${key} | ${MODEL_MAP[$key]} |" >> models.md
          done

          CONTENT=$(cat models.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
 

      - name: Update README
        run: |
          echo "${{ steps.fetch.outputs.content }}" > models_table.md

          FILES=("README.md" "README.zh-CN.md")

          for FILE in "${FILES[@]}"; do
            perl -Mutf8 -0777 -e '
              my $file = $ARGV[0];

              # 读取表格内容
              open my $fh, "<:encoding(UTF-8)", "models_table.md" or die $!;
              my $table = do { local $/; <$fh> };
              close $fh;

              # 读取 README 内容
              open my $in, "<:encoding(UTF-8)", $file or die $!;
              my $content = do { local $/; <$in> };
              close $in;

              # 替换 START/END 区域
              $content =~ s|<!-- START:models -->.*?<!-- END:models -->|<!-- START:models -->\n$table\n<!-- END:models -->|s;

              # 写回临时文件
              open my $out, ">:encoding(UTF-8)", "$file.tmp" or die $!;
              print $out $content;
              close $out;
            ' "$FILE"

            # 确保临时文件存在再覆盖
            if [ -f "$FILE.tmp" ]; then
              mv "$FILE.tmp" "$FILE"
            else
              echo "Error: temporary file $FILE.tmp not found"
              exit 1
            fi
          done
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git add README.zh-CN.md
          git commit -m "update HuggingFace models list" || echo "No changes"
          git push

